{% load static i18n %}
<fieldset id="car_fieldset" style="display: none">
    <legend>Transport vositasi</legend>
    <form action="#" id="save_car_form" method="post">
        {% csrf_token %}
        <input type='hidden' value="0" name="person_type">
        <input type='hidden' value="" name="organization">
        <input type='hidden' value="" name="seriya">
        <input type='hidden' value="" name="contract_date">


        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="car">{% trans 'Transport vositasi modelini tanlang' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 car">
                <select id="car" name="car" required class="form-control"
                        data-width="100%">
                    <option></option>
                    <option data-style="color: blue;" value="new">Yangi model qo'shish</option>
                    {% for car in cars %}
                        <option value="{{ car.id }}">{{ car.title }}</option>
                    {% endfor %}

                </select>
            </div>
        </div>

        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="car_type">{% trans 'Transport vositasi turini tanlang' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <select id="car_type" name="car_type" required data-width="100%"
                        class="form-control select2">
                    {% for car_type in car_types %}
                        <option value="{{ car_type.id }}">{{ car_type.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="fuel_type">{% trans "Yoqilg'i turini tanlang" %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 fuel_type">

                <select id="fuel_type" name="fuel_type" class="form-control"
                        multiple="multiple">
                    {% for fuel_type in fuel_types %}
                        <option value="{{ fuel_type.id }}">{{ fuel_type.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="device">{% trans "Alohida belgilar" %}</label>
            <div class="col-8 col-xl-9">

                <select id="device" name="device" class="form-control"
                        multiple="multiple">
                    {% for device in devices %}
                        <option value="{{ device.id }}">{{ device.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="body_type">{% trans 'Kuzov turi' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <select id="body_type" name="body_type" class="form-control select2" required
                        data-width="100%">
                    {% for bodyType in bodyTypes %}
                        <option value="{{ bodyType.id }}">{{ bodyType.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="engine_number">{% trans 'Dvigitel raqami' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <input type="text" id="engine_number" name="engine_number"
                       class="form-control text-uppercase" required
                       placeholder="{% trans 'Masalan: WZX5645645456' %}"
                       autocomplete="off">
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="body_number">{% trans 'Kuzov raqami' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <input type="text" id="body_number" name="body_number"
                       class="form-control text-uppercase" required
                       placeholder="{% trans 'Masalan: XWB6595645456' %}"
                       autocomplete="off">
            </div>
        </div>
        <div class="row mb-3 chassis_number_div" style="display: none">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="chassis_number">{% trans 'Shassi raqami' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 chassis_number">
                <input type="text" id="chassis_number"
                       class="form-control text-uppercase" required
                       placeholder="{% trans 'Masalan: ZXW5642519873' %}"
                       autocomplete="off">
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="full_weight">{% trans "To'la vazni" %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 full_weight">
                <input type="number" id="full_weight" name="full_weight"
                       class="form-control" required
                       placeholder="{% trans 'Masalan: 20500' %}"
                       autocomplete="off">
                <p class="text-muted" style="font-size: small; margin-bottom: 0; text-align:start">Ushbu
                    qiymatni kilogrammda
                    kiriting!</p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="empty_weight">{% trans 'Yuksiz vazni' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 empty_weight">
                <input type="number" id="empty_weight" name="empty_weight"
                       class="form-control" required
                       placeholder="{% trans 'Masalan: 19500' %}"
                       autocomplete="off">
                <p class="text-muted" style="font-size: small; margin-bottom: 0; text-align:start">Ushbu
                    qiymatni kilogrammda
                    kiriting!</p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="engine_power">{% trans 'Dvigatel quvvati' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 engine_power">
                <input type="number" id="engine_power" name="engine_power"
                       class="form-control"
                       placeholder="{% trans 'Masalan: 120' %}"
                       autocomplete="off" required>
                <p class="text-muted" style="font-size: small; margin-bottom: 0; text-align:start">Ushbu
                    qiymatni kilogrammda
                    kiriting!</p>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="color">{% trans 'Rangi' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 color">
                <select id="color" name="color" required class="form-control select2 color"
                        data-width="100%">
                    <option></option>
                    <option data-style="color: blue;" value="new">Yangi rang qo'shish</option>
                    {% for color in color %}
                        <option value="{{ color.id }}">{{ color.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="made_year">{% trans 'Ishlab chiqarilgan vaqti' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <input type="date" id="made_year" name="made_year"
                       class="form-control" required>
            </div>
        </div>
        <div class="row mb-3">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="price">{% trans 'Transport vositasi narxi' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 price">
                <input type="number" id="price" name="price"
                       class="form-control" required
                       placeholder="{% trans 'Masalan: 47000000' %}"
                       autocomplete="off">
                <p class="text-muted" style="font-size: small; margin-bottom: 0; text-align:start">Ushbu
                    qiymatni so'mda
                    kiriting!</p>
            </div>
        </div>
        <div class="row mb-3" id="parent_is_saved_number">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="is_saved_number">{% trans 'Yangi olinadigan davlat raqam belgisi YXHB zahirasida saqlanmoqdami?' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <div class="row justify-content-start mt-1">
                    <div class="col-3 col-md-2 col-lg-2 col-xl-2">
                        <input type="radio" id="is_saved_number_yes" name="is_saved_number"
                               class="form-check-input" value="True">
                        <label class="form-check-label" for="is_saved_number_yes">Ha</label>
                    </div>
                    <div class="col-3 col-md-2 col-lg-2 col-xl-2">
                        <input type="radio" id="is_saved_number_no" name="is_saved_number"
                               class="form-check-input" checked value="False">
                        <label class="form-check-label" for="is_saved_number_no">Yoq</label>
                    </div>

                </div>


            </div>
        </div>
        <div class="row mb-3" id="saved_number_div" style="display: none">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="saved_number">{% trans "Zahiradagi raqam" %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <input type="text" id="saved_number"
                       class="form-control text-uppercase" required
                       placeholder="{% trans 'Masalan: 80979HBA' %}"
                       autocomplete="off">
            </div>
        </div>
        <div class="row mb-3" id="parent_is_auction">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="is_auction">{% trans 'Raqam auksiondan olinganmi?' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <div class="row justify-content-start mt-1">
                    <div class="col-3 col-md-2 col-lg-2 col-xl-2">
                        <input type="radio" id="is_auction_yes" name="is_auction"
                               class="form-check-input" value="True">
                        <label class="form-check-label" for="is_auction_yes">Ha</label>
                    </div>
                    <div class="col-3 col-md-2 col-lg-2 col-xl-2">
                        <input type="radio" id="is_auction_no" name="is_auction"
                               class="form-check-input" checked value="False">
                        <label class="form-check-label" for="is_auction_no">Yoq</label>
                    </div>

                </div>


            </div>
        </div>
        <div class="row mb-3" id="auction_number_div">
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="auction_number">{% trans "Auksion raqami" %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9">
                <input type="text" id="auction_number"
                       class="form-control text-uppercase" required
                       placeholder="{% trans 'Masalan: 80979HBA' %}"
                       autocomplete="off">
            </div>
        </div>
        <div class="justify-content-end row">
            <div class="col-12">
                <button type="button"
                        class="btn btn-secondary waves-effect waves-light float-start prev">Oldingi
                </button>
                <button type="button" id="fake" class="btn btn-danger">Fake</button>
                <button type="submit"
                        class="btn btn-info waves-effect waves-light float-end next">Keyingi
                </button>
            </div>
        </div>
    </form>
</fieldset>

{% block modals %}
    {% include 'common/add_car_model_modal.html' %}
    {% include 'common/add_car_color_modal.html' %}
{% endblock modals %}

{% block js %}
    <script src="{% static 'assets/libs/jquery/jquery.min.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $('.select2').select2({
                width: '100%'
            })

            $('#auction_number_div').hide()

        })
        $(document).ready(function () {
            $('#fake').on('click', function () {
                generate_fake_data()
            })

            $('#fuel_type').selectize({
                inputClass: 'form-control selectize-input',
                placeholder: "Masalan: BENZIN",
                sortField: "text",
            });

            $('#device').selectize({
                inputClass: 'form-control selectize-input',
                dropdownParent: "body",
                placeholder: "Masalan: MAXSUS",
            });

            $('input[name=is_auction]').on('change', function () {
                if ($('#is_auction_yes').prop('checked')) {
                    $('#auction_number_div').show()
                    $('#saved_number_div').hide()
                    $('#parent_is_saved_number').hide()
                } else {
                    $('#auction_number_div').hide()
                    $('#parent_is_saved_number').show()
                }
            })


            $('input[name=is_saved_number]').on('change', function () {
                if ($('#is_saved_number_yes').prop('checked')) {
                    $('#saved_number_div').show()
                    $('#auction_number_div').hide()
                    $('#parent_is_auction').hide()
                } else {
                    $('#saved_number_div').hide()
                    $('#parent_is_auction').show()
                }
            })


            function ChangeCarType() {
                var selectedCar = $('select#car').children("option:selected").val();

                if (!selectedCar === 'new') {
                    $.ajax({
                        type: "POST",
                        url: "{% url 'user:get_car_type' %}",
                        data: {
                            'car': selectedCar, // from form
                        },
                        statusCode: {
                            200: function (response) {
                                console.log(response)
                                if (response === "True") {
                                    //agar yuk avtomobil bo'lsa
                                    $('.chassis_number_div').show()
                                    $('#chassis_number').attr('name', 'chassis_number')

                                } else {
                                    //agar yengil avtomobil bo'lsa

                                    $('.chassis_number_div').hide()
                                    $('#chassis_number').removeAttr('name')
                                }
                            }, 400: function (err) {
                                console.log(err)
                                console.log(err.responseText)
                                error_toast()
                            }, 500: function (err) {
                                console.log(err)
                                console.log(err.responseText)
                                error_toast()
                            }
                        },
                    });
                }
            }

            $("select#car").change(function () {
                ChangeCarType()
            });

            $('#fuel_type').on('change', function () {
                var selectedFuelType = $(this).children("option:selected").val();
                if (parseInt(selectedFuelType)) {
                    $(this).valid()
                }
            })

            $('#car').on('change', function () {
                var selectedCarModel = $(this).children("option:selected").val();
                if (parseInt(selectedCarModel)) {
                    $(this).valid()
                }
            })

            $('#color').on('change', function () {
                var selectedColor = $(this).children("option:selected").val();
                if (parseInt(selectedColor)) {
                    $(this).valid()
                }
            })

            var $carForm = $('#save_car_form');
            if ($carForm.length) {
                var carButton = $carForm.children().find('button:submit')
                $carForm.validate({
                    ignore: ":hidden:not('#fuel_type')",

                    rules: {
                        //username is the name of the textbox
                        engine_number: {
                            required: true,
                            //alphanumeric is the custom method, we defined in the above
                            alphanumeric: true,
                            noSpace: true,
                        },
                        body_number: {
                            required: true,
                            alphanumeric: true,
                            noSpace: true,
                        },
                        chassis_number: {
                            required: true,
                            alphanumeric: true,
                            noSpace: true,
                        },
                        fuel_type: {
                            required: true,
                        },
                        car: {
                            required: true,
                            selectRequired: true,
                        },
                        color: {
                            required: true,
                            selectRequired: true,
                        },
                        full_weight: {
                            required: true,
                        },
                        empty_weight: {
                            required: true,
                        },
                        engine_power: {
                            required: true,
                        },
                        price: {
                            required: true,
                        },
                        made_year: {
                            required: true,
                            date: true,
                        },
                        seriya: {
                            required: true,
                            alphanumeric: true,
                            noSpace: true,
                        },
                        auction_number: {
                            required: true,

                        },


                    },
                    messages: {
                        car: {
                            //error message for the required field
                            required: 'Transport vositasi modeli tanlanmagan!'
                        },
                        engine_number: {
                            //error message for the required field
                            required: 'Dvigatel raqami kiritilmagan!'
                        },
                        body_number: {
                            required: 'Kuzov raqami kiritilmagan!'
                        },
                        chassis_number: {
                            required: 'Shassi raqami kiritilmagan!'
                        },
                        fuel_type: {
                            required: "Yoqilg'i turi tanlanmagan!",
                        },
                        full_weight: {
                            required: "To'la vazn kiritilmagan!",
                        },
                        empty_weight: {
                            required: "Yuksiz vazn kiritilmagan!",
                        },
                        engine_power: {
                            required: "Dvigatel quvvati kiritilmagan!",
                        },
                        made_year: {
                            required: "Ishlab chiqarilgan vaqti kiritilmagan!",
                        },
                        color: {
                            required: "Transport vositasi rangi tanlanmagan!",
                        },
                        price: {
                            required: "Transport vositasi narxi kiritilmagan!",
                        },
                        seriya: {
                            required: "Hisob ma'lumotnomasi seriyasi va raqami kiritilmagan!"
                        },
                        auction_number: {
                            required: "Auksion raqami kiritilmagan!"
                        },


                    },
                    errorPlacement: function (error, element) {
                        if (element.is("#car")) {
                            error.appendTo(element.parents('.car'));
                        } else if (element.is("#fuel_type")) {
                            error.appendTo(element.parents('.fuel_type'));
                        } else if (element.is("#color")) {
                            error.appendTo(element.parents('.color'));
                        } else if (element.is(":checkbox")) {
                            error.appendTo(element.parents('.device'));
                        } else if (element.is("#full_weight")) {
                            error.appendTo(element.parents('.full_weight'));
                        } else if (element.is("#empty_weight")) {
                            error.appendTo(element.parents('.empty_weight'));
                        } else if (element.is("#engine_power")) {
                            error.appendTo(element.parents('.engine_power'));
                        } else if (element.is("#price")) {
                            error.appendTo(element.parents('.price'));
                        } else {
                            error.insertAfter(element);
                        }

                    },


                    submitHandler: function (form, e) {
                        e.preventDefault()

                        carButton.attr('disabled', true)
                        var carButtonValue = carButton.text()
                        carButton.html(`${carButtonValue}&nbsp<i class="fas fa-spinner fa-spin"></i>`)

                        var device = []
                        $('.device').each(function () {
                            if ($(this).prop('checked')) {
                                device.push($(this).data('device'))
                            }
                        })

                        $('input[name ="device"]').val(device)
                        $('#car').attr('name', 'model')
                        $('#car_type').attr('name', 'type')

                        if ($('#is_saved_number_yes').prop('checked') === true) {
                            $("<input />").attr("type", "hidden")
                                .attr("name", "given_number")
                                .attr("value", $('#saved_number').val()).appendTo(form);
                        } else {
                            $("<input />").attr("type", "hidden")
                                .attr("name", "given_number")
                                .attr("value", $('#auction_number').val()).appendTo(form);
                        }

                        $("<input />").attr("type", "hidden")
                            .attr("name", "applicant")
                            .attr("value", $('#person').val()).appendTo(form);

                        $.ajax({
                            type: "POST",
                            url: "{% url 'api_application:create_account_statement' %}",
                            data: $(form).serialize(),
                            statusCode: {
                                201: function (response) {
                                    console.log(response)
                                    carButton.parents('fieldset').hide()
                                    carButton.parents('fieldset').nextAll('fieldset').first().show()

                                    carButton.attr('type', 'button');
                                    carButton.attr('disabled', false);
                                    carButton.html(carButtonValue)


                                    $('input[name ="application"]').val(response.id)

                                    $('#section_step').addClass('active')
                                    $('#car_step').removeClass('active')

                                    $('#car').attr('disabled', 'disabled')
                                    $('#engine_number').attr("disabled", "disabled")
                                    $('#body_number').attr("disabled", "disabled")
                                    $('#chassis_number').attr("disabled", "disabled")
                                    $('#body_type').attr("disabled", "disabled")
                                    $('#color').attr("disabled", "disabled")
                                    $('#made_year').attr("disabled", "disabled")
                                    $('.device').attr("disabled", "disabled")
                                    $('#seriya').attr("disabled", "disabled")
                                    $('#contract_date').attr("disabled", "disabled")
                                    $('#fuel_type').attr("disabled", "disabled")
                                    $('#car_type').attr("disabled", "disabled")
                                    $('#empty_weight').attr("disabled", "disabled")
                                    $('#full_weight').attr("disabled", "disabled")
                                    $('#engine_power').attr("disabled", "disabled")
                                    $('#auction_number').attr("disabled", "disabled")
                                    $('#is_auction_yes').attr("disabled", "disabled")
                                    $('#is_auction_no').attr("disabled", "disabled")
                                    $('#saved_number').attr("disabled", "disabled")
                                    $('input[name=is_saved_number]').attr("disabled", "disabled")
                                    $('#price').attr("disabled", "disabled")
                                },
                                400: function (err) {
                                    console.log(err)
                                    var errorKey
                                    var errorText
                                    var keys = Object.keys(err.responseJSON);

                                    keys.forEach(function (key) {
                                        errorText = err.responseJSON[key];
                                        errorKey = key;
                                    });
                                    Swal.fire(
                                        'Xatolik!',
                                        `${errorKey} ${errorText}`,
                                        `error`,
                                    )

                                    carButton.attr('type', 'submit')
                                    carButton.attr('disabled', false)
                                    carButton.html(carButtonValue)
                                }
                            },
                        });
                        return false; // required to block normal submit since you used ajax
                    }
                });
            }

        })
    </script>
{% endblock js %}