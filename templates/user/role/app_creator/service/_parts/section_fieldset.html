{% load i18n static %}

<fieldset id="section_fieldset" style="display: none">
    <legend>Ariza topshirish hududi</legend>
    <form action="#" id="save_section_form">
        <input type="hidden" name="application">
        <div class="row mb-3">
            <div class="alert alert-info">
                <p style="font-size: 1.4rem; font-weight: bold">ARIZA TOPSHIRISH HUDUDI</p>
                <p style="font-size: 1.2rem; font-weight: bold">Albatta o'qib chiqing</p>
                <p>Ariza topshirmoqchi bo'lgan viloyatingiz va unga tegishli RIB yoki TRIB'larni tanlashingiz mumkin.
                    Buning
                    uchun viloyatni tanlang va ostki qismda chiqadigan RIB yoki TRIB'lar ro'yhatidan o'zingizga yaqin va
                    qulay bo'lganini tanlashingiz mumkin</p>
            </div>
            <label class="not_copy col-4 col-xl-3 col-form-label text-start"
                   for="region">{% trans 'Ariza topshiradigan viloyatni tanlang' %}<span
                    class="text-danger">*</span></label>
            <div class="col-8 col-xl-9 car">
                <select id="section_region" name="section_region" required class="form-control select2">
                </select>
            </div>
        </div>

        <div class="card-body">
            <h4 class="header-title">Tuman va shahar ro'yhatga olish bo'limlari</h4>
            <p class="sub-header">Lorem Ipsum is simply dummy text of the printing and typesetting
                industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s,
                when an unknown printer took electronic typesetting, remaining essentially
                unchanged.</p>

            <ol class="list-group list-group-numbered" id="sections_list">
            </ol>
        </div>
        <div class="justify-content-end row">
            <div class="col-12">
                <button type="button" class="btn btn-secondary waves-effect waves-light float-start prev">Oldingi
                </button>

            </div>
        </div>
    </form>
</fieldset>
{% block js %}
    <script src="{% static 'assets/libs/jquery/jquery.min.js' %}" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            sendAuthorizationToken()

            getAjaxData('{% url "api_user:regions_list" %}').then(function (res) {
                console.log(51, res)
                res.forEach((x, i) =>
                    $("#section_region").select2({
                        data: [{id: x.id, text: `${x.title}`}],
                        width: '100%',
                        placeholder: '-- viloyatni tanlang --',
                    })
                );
            })


            $(document).on('change', '#section_region', function () {
                var SelectedRegion = $('#section_region').children("option:selected").val()

                getAjaxData('{% url "api_user:region_sections_list" pk=12345 %}'.replace(/12345/, SelectedRegion.toString())).then(function (res) {
                    var li = ''
                    $.each(res, function (i, x) {
                        try {
                            li += `<li class="list-group-item d-flex justify-content-between align-items-start">
                                                <div class="ms-2 me-auto col-7 col-xs-8 col-sm-8 col-md-8 col-lg-8 col-xl-9 text-start">
                                                    <div class="fw-bold text-start text-start">${x.title}</div>
                                                    ${x.region.title}, ${x.located_district.title}, ${x.quarter.title}
                                                </div>
                                                <div class="col-5 col-xs-4 col-sm-4 col-md-4 col-lg-4 col-xl-3">
                                                    <button type="button" data-id="${x.id}" class="btn btn-info waves-effect waves-light send_application"  >Ariza topshirish
                                                    </button>
                                                </div>
                                            </li>`
                        } catch (err) {
                            console.log(err)
                            swal_error("YHXB bo'limi joylashgan manzil topilmadi!")
                        }
                    })
                    $('#sections_list').html(li)
                }, function (err) {
                    console.log(err)
                    swal_error(err)
                })
            })

            $(document).on('click', '.send_application', function () {
                var applicationId = $('input[name ="application"]').val()

                $('#load').show()
                var url = '/'
                $.ajax({
                    type: 'POST',
                    url: '{% url "application:save_application_section" %}',
                    data: {
                        'section': $(this).data("id"),
                        'application': applicationId
                    },
                    statusCode: {
                        200: function (res) {
                            console.log(res)
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                background: '#72fabd',
                                showConfirmButton: false,
                                timer: 2500,
                                timerProgressBar: false,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                },
                                onClose: (toast) => {
                                    url = "{% url "application:application_detail" 12345 %}".replace(/12345/, applicationId);
                                    window.location.href = url
                                }
                            })
                            Toast.fire({
                                icon: 'success',
                                title: 'Arizangiz muvaffaqiyatli topshirildi!'
                            })
                        },
                        400: function (err) {
                            console.log(err)
                            console.log(err.responseText)
                            error_toast()
                            $('#load').hide()
                        },
                        404: function (err) {
                            console.log(err)
                            console.log(err.responseText)
                            error_toast()
                            $('#load').hide()
                        }
                    }
                })

            });
        })
    </script>


{% endblock js %}