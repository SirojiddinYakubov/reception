{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
    <section class="py-3 mt-2 bg-info text-light">
        <div class="container">
            <div class="row text-center">
                <div class="col-12">
                    <h2>{% trans "Xadya shartnomasiga asosan avtotransport vositasiga raqam olish" %}</h2>
                </div>
            </div>
        </div>
    </section>
    <div class="row ml-2 mr-2">
        <div class="col-12 text-center p-0 mt-3 mb-2">
            <div class="card px-0 pt-4 pb-0 mt-3 mb-3">
                <div class="row">
                    <div class="col-md-12 mx-0">
                        <div id="msform">
                            <!-- progressbar -->
                            <ul id="progressbar">
                                <li class="active not_copy" id="personal"><strong>Foydalanuvchi</strong></li>
                                <li class="not_copy" id="car_icon"><strong>Avtotransport</strong></li>
                                <li class="not_copy" id="payment"><strong>To'lov</strong></li>
                            </ul> <!-- fieldsets -->
                            <fieldset id="fieldset1">
                                <div class="form-card">
                                    <h2 class="fs-title not_copy">Foydalanuvchi ma'lumotlari</h2>

                                    <div class="col-12">
                                        <label class="not_copy">Foydalanuvchini tanlang?</label>
                                        <select class="form-control" style="width: 100%;" id="person_type" required>
                                            <option value="J">Jismoniy shaxs</option>
                                            <option value="Y">Yuridik shaxs</option>
                                        </select>
                                        <p style="margin-top: 0;margin-bottom: 0; font-size: 0.8em"
                                           id="organization_div_alert"
                                           class="text-danger not_copy">
                                            Sizda tashkilot mavjud emas. <a
                                                href="{% url 'user:add_organization' %}">Tashkilotni
                                            qo'shish </a> bo'limiga o'tib, tashkilotni ro'yhatga oling
                                        </p>
                                    </div>

                                    <div class="col-12" id="div_organization">
                                        {% if organizations.count > 0 %}
                                            <div class="form-group">
                                                <label class="not_copy">{% trans 'Korxonani tanlang:' %}</label>
                                                <select id="organization"
                                                        class="form-control select2"
                                                        style="width: 100%;">
                                                    {% for organization in organizations %}
                                                        <option value="{{ organization.id }}">{{ organization.title }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12" id="msdiv1">
                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="not_copy">{% trans 'Familiya:' %}</label>
                                                <input type="text" id="last_name" class="form-control"
                                                       value=""
                                                       disabled>
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="not_copy">{% trans 'Ism:' %}</label>
                                                <input type="text" id="first_name" class="form-control"
                                                       value=""
                                                       disabled>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="not_copy mt-2">{% trans 'Otasining ismi:' %}</label>
                                                <input type="text" id="middle_name" class="form-control" value=""
                                                       disabled>
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="not_copy mt-2">{% trans 'Passport:' %}</label>
                                                <input type="text" id="passport" class="form-control" value=""
                                                       disabled>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-12" id="msdiv2" style="display: none">
                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label>{% trans 'Rahbar:' %}</label>
                                                <input type="text" id="director" class="form-control" placeholder=""
                                                       disabled>
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label>{% trans 'STIR raqam:' %}</label>
                                                <input type="text" id="identification_number" class="form-control"
                                                       placeholder=""
                                                       disabled>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label>{% trans 'Yuridik manzil:' %}</label>
                                                <input type="text" id="legal_address" class="form-control"
                                                       placeholder="" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <button type="button" id="next1" name="next" class="next action-button">
                                    Keyingi
                                </button>
                            </fieldset>
                            <fieldset id="fieldset2">
                                <form action="#" id="save_car_form" method="post">
                                    {% csrf_token %}
                                    <div class="form-card">
                                        <h2 class="fs-title not_copy">Avtotransport ma'lumotlari</h2>
                                        <input type='hidden' value="J" name="person_type">
                                        <input type='hidden' value="" name="organization">
                                        <input type='hidden' value="" name="devices">
                                        <label class="label_required">{% trans 'Avtomobil modelini tanlang' %}</label>
                                        <select id="car" name="car" class="form-control select2" style="width: 100%;">
                                            {% for car in cars %}
                                                <option value="{{ car.id }}">{{ car.title }}</option>
                                            {% endfor %}
                                        </select>


                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required"
                                                       for="engine_number">{% trans 'Dvigitel raqami' %}</label>
                                                <input type="text" id="engine_number" name="engine_number"
                                                       class="form-control"
                                                       placeholder="{% trans 'Masalan: B12D12345678DJCCX1234' %}"
                                                       autocomplete="off">
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required"
                                                       for="body_number">{% trans 'Kuzov raqami' %}</label>
                                                <input type="text" id="body_number" name="body_number"
                                                       class="form-control" autocomplete="off"
                                                       placeholder="{% trans 'Masalan: XWBJF69VELA102923' %}">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label>{% trans "Qo'shimcha jihozlar" %}</label>
                                                <div class="form-check">
                                                    {% for device in devices %}
                                                        <input type="checkbox"
                                                               data-device="{{ device.id }}"
                                                               class="form-check-input devices"/>
                                                        <label class="form-check-label"
                                                               for="devices"><b>{{ device.title }}</b></label>
                                                        <br>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label for="body_type"
                                                       class="label_required">{% trans 'Kuzov turi' %}</label>
                                                <select id="body_type" name="body_type" class="form-control select2"
                                                        style="width: 100%;">
                                                    {% for bodyType in bodyTypes %}
                                                        <option value="{{ bodyType.id }}">{{ bodyType.title }}</option>
                                                    {% endfor %}
                                                </select>

                                                <label for="chassis_number" id="chassis_number_label"
                                                       class="mt-2 label_required">{% trans 'Shassi raqami' %}</label>
                                                <input type="text" id="chassis_number" name="chassis_number"
                                                       class="form-control"
                                                       placeholder="{% trans 'Masalan: X8945642519874656' %}"
                                                       autocomplete="off">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required" for="color">{% trans 'Rangi' %}</label>
                                                <select id="color" name="color" class="form-control select2">
                                                    {% for color in color %}
                                                        <option value="{{ color.id }}">{{ color.title }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required" for="made_year">{% trans 'Yili' %}</label>
                                                <select id="made_year" name="made_year" class="form-control select2">
                                                    {% for year in years %}
                                                        <option value="{{ year }}">{{ year }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>


                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required"
                                                       for="gift_agreement">{% trans "Xadya shartnomasi seriyasi va raqami" %}</label>
                                                <input type="text" id="gift_agreement" name="gift_agreement"
                                                       class="form-control"
                                                       placeholder="{% trans 'Masalan: AAC123456' %}"
                                                       autocomplete="off">
                                            </div>
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <label class="label_required"
                                                       for="date_conclusion_contract">{% trans "Shartnoma tuzilgan sana" %}</label>
                                                <div class="input-group mb-2">
                                                    <input id='date_conclusion_contract' name="date_conclusion_contract"
                                                           type="text"
                                                           class="form-control datepicker"/>
                                                    <div class="input-group-prepend datepicker_icon">
                                                        <div class="input-group-text"><i class="fa fa-calendar"
                                                                                         aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12 col-md-6 col-sm-6 col-lg-6 col-xl-6 mt-2">
                                                <div class="form-check">
                                                    <input type="checkbox" id="lost_technical_passport"
                                                           name="lost_technical_passport"
                                                           class="form-check-input devices"/>
                                                    <label class="form-check-label"
                                                           for="devices"><b>texnik passport yo'qolgan</b></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row justify-content-center">
                                        <input type="button" id="prev2"
                                               class="previous action-button-previous"
                                               value="Oldingi"/>
                                        <input type="submit" id="next2" class="action-button"
                                               value="Keyingi"/>
                                        <input type="button" style="display: none" id="refresh_next2"
                                               class="action-button"
                                               value="Keyingi"/>
                                    </div>
                                </form>
                            </fieldset>
                            <fieldset id="fieldset3-person">
                                <div class="form-card">
                                    <div class="row no-gutters d-flex justify-content-center">
                                        <div class="col-md-10">
                                            <div class="payment-info">
                                                <div class="row">
                                                    <img class="img-fluid cc-img"
                                                         src="http://www.prepbootstrap.com/Content/images/shared/misc/creditcardicons.png">
                                                </div>

                                                <div class="mt-2">
                                                    <label class="credit-card-label label_required">Karta egasi</label>
                                                    <input type="text" class="credit-inputs form-control"
                                                           placeholder="Masalan: Abdullayev Bahtiyor">
                                                </div>
                                                <div class="mt-2">
                                                    <label class="credit-card-label label_required">Karta raqami</label>
                                                    <input type="text" class="credit-inputs form-control"
                                                           placeholder="0000 0000 0000 0000">
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label class="credit-card-label label_required">Vaqti</label>
                                                        <input type="text" class="credit-inputs form-control"
                                                               placeholder="12/24">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="credit-card-label label_required">Maxfiy
                                                            kod</label>
                                                        <input type="text" class="credit-inputs form-control"
                                                               placeholder="342">
                                                    </div>
                                                </div>
                                                <hr class="line">
                                                <div class="d-flex justify-content-between information">
                                                    <span>Yangi raqam uchun</span>
                                                    <span>560 000 so'm</span>
                                                </div>
                                                <hr style="margin: 0; background-color: #b6b6b6">
                                                <div class="d-flex justify-content-between information">
                                                    <span>Tex passport uchun</span>
                                                    <span>350 000 so'm</span>
                                                </div>
                                                <hr style="margin: 0; background-color: #b6b6b6">
                                                <div class="d-flex justify-content-between information">
                                                    <span>Ro'yhatlash uchun</span>
                                                    <span>22 300 so'm</span>
                                                </div>
                                                <hr style="margin: 0; background-color: #b6b6b6">
                                                <div class="d-flex justify-content-between information">
                                                    <span>Qayta ro'yhatlash uchun</span>
                                                    <span>44 600 so'm</span>
                                                </div>
                                                <hr style="margin: 0; background-color: #3e3e3e">
                                                <div class="d-flex justify-content-between information">
                                                    <span><b>Jami to'lov</b></span>
                                                    <span><b>976 900 so'm</b></span>
                                                </div>
                                                <div class="text-right mt-3">
                                                    <button class="btn btn-primary col-12"
                                                            type="button"><span style="float:left;" class="pl-1">To'lov qilish</span>
                                                        <span style="float:right;"><i
                                                                class="fas fa-long-arrow-alt-right"></i></span>
                                                    </button>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="button" name="Previous" class="previous action-button-previous"
                                       id="prev3" value="Oldingi"/>
                                <a target="_blank" href="#"
                                   class="action-button copy_application" style="padding: 0.7em !important;">
                                    Ariza nusxasini olish &nbsp&nbsp<i class="fas fa-download"></i>
                                </a>
                            </fieldset>
                            <fieldset id="fieldset3-legal">
                                <div class="form-card">
                                    <div class="alert alert-danger text-center"><b>Ushbu to'lovlarni hisob-raqamingizdan
                                        pul ko'chirish
                                        yo'li orqali to'lang!!!</b></div>
                                    <div id="render_div" class="row no-gutters d-flex justify-content-center">
                                        <div class="col-md-10">
                                            <div class="payment-info table-responsive-sm">
                                                <table class="table table-bordered">
                                                    <thead class="thead-light">
                                                    <tr>
                                                        <th scope="col">#</th>
                                                        <th scope="col">Hujjat nomi</th>
                                                        <th scope="col">Hisob raqami</th>
                                                        <th scope="col">Summasi</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr>
                                                        <td>1</td>
                                                        <th scope="row">Yo'l fondi ot kuchi</th>
                                                        <td>401422860406242342210179</td>
                                                        <td>33 000</td>
                                                    </tr>

                                                    <tr>
                                                        <td>2</td>
                                                        <th scope="row">Texnik ko'rik</th>
                                                        <td>401422860406242342210179</td>
                                                        <td>22 300</td>
                                                    </tr>

                                                    <tr>
                                                        <td>3</td>
                                                        <th scope="row">Ro'yhatlash</th>
                                                        <td>401422860406242342210179</td>
                                                        <td>22 300</td>
                                                    </tr>

                                                    <tr>
                                                        <td>4</td>
                                                        <th scope="row">Qayta ro'yhatlash</th>
                                                        <td>401422860406242342210179</td>
                                                        <td>44 600</td>
                                                    </tr>
                                                    </tbody>

                                                    <tfoot>
                                                    <tr>
                                                        <td></td>
                                                        <td><b>Jami to'lov:</b></td>
                                                        <td></td>
                                                        <td><b>366 000</b></td>
                                                    </tr>
                                                    </tfoot>
                                                </table>
                                                <div class="text-right mt-3">
                                                    <button id="payment_render_pdf"
                                                            class="btn btn-secondary col-4 col-md-3 col-sm-3 col-lg-3 col-xl-3 m-2">
                                                        To'lovlarni pdf holatda chiqarish &nbsp&nbsp<i
                                                            class="fas fa-file-download"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="button" name="Previous" class="previous action-button-previous"
                                       id="prev3" value="Oldingi"/>
                                <a target="_blank" href="#"
                                   class="action-button copy_application" style="padding: 0.7em !important;">
                                    Ariza nusxasini olish &nbsp&nbsp<i class="fas fa-download"></i>
                                </a>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock content %}

{% block bottom %}
    <script type="text/javascript" charset="UTF-8">
        $(function () {
            $('.select2').select2()
            $('#organization_div_alert').hide()

        })
        $(document).ready(function () {
            var is_legal = false,
                passport = '{{ request.user.passport_seriya }}{{ request.user.passport_number }}',
                firstName = '{{ request.user.first_name }}',
                lastName = '{{ request.user.last_name }}',
                middleName = '{{ request.user.middle_name }}',
                token = getCookie('token'),
                csrftoken = getCookie('csrftoken')

            $('#first_name').attr('value', firstName)
            $('#last_name').attr('value', lastName)
            $('#middle_name').attr('value', middleName)
            $('#passport').attr('value', passport)

            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', csrftoken)
                    xhr.setRequestHeader('Authorization', `Token ${token}`)
                },
                error: function (response) {
                    if (response.status === 401) {
                        $.notifyDefaults({
                            type: 'danger',
                            allow_dismiss: false,
                            animate: {
                                enter: 'animated fadeInRight',
                                exit: 'animated fadeOutRight'
                            },
                            z_index: '9999'
                        })
                        $.notify({
                            icon: 'glyphicon glyphicon-star',
                            message: '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-patch-exclamation" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n' +
                                '  <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>\n' +
                                '  <path fill-rule="evenodd" d="M10.273 2.513l-.921-.944.715-.698.622.637.89-.011a2.89 2.89 0 0 1 2.924 2.924l-.01.89.636.622a2.89 2.89 0 0 1 0 4.134l-.637.622.011.89a2.89 2.89 0 0 1-2.924 2.924l-.89-.01-.622.636a2.89 2.89 0 0 1-4.134 0l-.622-.637-.89.011a2.89 2.89 0 0 1-2.924-2.924l.01-.89-.636-.622a2.89 2.89 0 0 1 0-4.134l.637-.622-.011-.89a2.89 2.89 0 0 1 2.924-2.924l.89.01.622-.636a2.89 2.89 0 0 1 4.134 0l-.715.698a1.89 1.89 0 0 0-2.704 0l-.92.944-1.32-.016a1.89 1.89 0 0 0-1.911 1.912l.016 1.318-.944.921a1.89 1.89 0 0 0 0 2.704l.944.92-.016 1.32a1.89 1.89 0 0 0 1.912 1.911l1.318-.016.921.944a1.89 1.89 0 0 0 2.704 0l.92-.944 1.32.016a1.89 1.89 0 0 0 1.911-1.912l-.016-1.318.944-.921a1.89 1.89 0 0 0 0-2.704l-.944-.92.016-1.32a1.89 1.89 0 0 0-1.912-1.911l-1.318.016z"/>\n' +
                                '</svg> Xatolik yuz berdi! Token yaroqsiz!'
                        })
                        setTimeout(function () {
                            window.location.href = '{% url "user:custom_logout" %}'
                        }, 3000);
                    }
                }
            })

            function changeOrganizationValues() {
                $.ajax({
                    type: 'GET',
                    url: '{% url "user:get_organization" %}',
                    data: {'organization': $('#organization option:selected').val()},
                    success: function (response) {
                        $('#director').attr('value', response.fields.director)
                        $('#legal_address').attr('value', response.fields.legal_address)
                        $('#identification_number').attr('value', response.fields.identification_number)

                        $('input[name ="organization"]').val($('#organization option:selected').val())

                        $('#organization_title').html(response.fields.title)
                        $('#organization_director').html(response.fields.director)
                        $('#organization_legal_address').html(response.fields.legal_address)
                        $('#organization_identification_number').html(response.fields.identification_number)
                    }
                })
            }

            $('#div_organization').hide()

            $("#person_type").change(function () {
                var selectedPersonType = $(this).children("option:selected").val();
                $('input[name ="person_type"]').val(selectedPersonType)
                if (selectedPersonType === 'Y') {
                    changeOrganizationValues()

                    $('#div_organization').show()
                    $('#msdiv1').hide()
                    $('#msdiv2').show()
                    is_legal = true

                    $('#organization').on('change', function () {
                        changeOrganizationValues()
                    })

                    if (typeof ($('#organization option').attr('value')) == 'undefined') {
                        $('#organization_div_alert').show()
                    } else {
                        $('#organization_div_alert').hide()
                    }
                } else if (selectedPersonType === 'J') {
                    $('#organization_div_alert').hide()
                    $('#msdiv1').show()
                    $('#msdiv2').hide()
                    $('#div_organization').css('display', 'none')
                    is_legal = false
                }
            });

            $('#next1').on('click', function () {
                $('#person_type').attr('disabled', true)
                $('#organization').attr('disabled', true)
                $('#fieldset1').hide()
                $('#fieldset2').show()
                $('#car_icon').addClass('active')
            })

            ChangeCarType()

            function ChangeCarType() {
                var selectedCar = $('select#car').children("option:selected").val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'user:get_car_type' %}",
                    data: {
                        'car': selectedCar, // from form
                    },
                    success: function (response) {
                        if (response === "True") {
                            //agar yuk avtomobil bo'lsa
                            $('#chassis_number_label').show()
                            $('#chassis_number').show()
                        } else {
                            //agar yengil avtomobil bo'lsa
                            $('#chassis_number_label').hide()
                            $('#chassis_number').hide()
                        }
                    },
                    error: function (response) {
                        console.log(response.status)
                    }

                });
            }

            $("select#car").change(function () {
                ChangeCarType()
            });

            $('#prev2').on('click', function () {
                $('#fieldset2').hide()
                $('#fieldset1').show()
            })

            $('#prev3').on('click', function (e) {
                $('#fieldset3-legal').hide()
                $('#fieldset3-person').hide()
                $('#fieldset2').show()
            })

            $('#refresh_next2').on('click', function (e) {
                $('#fieldset2').hide()
                if (is_legal === true) {
                    $('#fieldset3-legal').show()
                } else {
                    $('#fieldset3-person').show()
                }

            })


            jQuery.validator.addMethod("noSpace", function (value, element) {
                return value == '' || value.trim().length != 0;
            }, "Iltimos bo'sh joy qoldirmang!");
            jQuery.validator.addMethod("customEmail", function (value, element) {
                return this.optional(element) || /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(value);
            }, "Iltimos, to'g'ri elektron pochta manzilini kiriting!");
            $.validator.addMethod("alphanumeric", function (value, element) {
                return this.optional(element) || /^\w+$/i.test(value);
            }, "Faqat harf va raqam kiriting!");
            var $registrationForm = $('#save_car_form');
            if ($registrationForm.length) {
                $registrationForm.validate({
                    ignore: ":hidden",
                    rules: {
                        //username is the name of the textbox
                        engine_number: {
                            required: true,
                            //alphanumeric is the custom method, we defined in the above
                            alphanumeric: true,
                            noSpace: true,
                        },
                        body_number: {
                            required: true,
                            alphanumeric: true,
                            noSpace: true,
                        },
                        gift_agreement: {
                            required: true,
                            alphanumeric: true,
                            noSpace: true,
                        },


                    },
                    messages: {
                        engine_number: {
                            //error message for the required field
                            required: 'Dvigatel raqami kiritilmagan!'
                        },
                        body_number: {
                            required: 'Kuzov raqami kiritilmagan!'
                        },
                        gift_agreement: {
                            required: "Xadya shartnomasi seriyasi va raqami kiritilmagan!"
                        },


                    },
                    errorPlacement: function (error, element) {
                        if (element.is(":radio")) {
                            error.appendTo(element.parents('.devices'));
                        } else if (element.is(":checkbox")) {
                            error.appendTo(element.parents('.devices'));
                        } else {
                            error.insertAfter(element);
                        }

                    },

                    submitHandler: function (form) {
                        var devices = []
                        $('.devices').each(function () {
                            if ($(this).prop('checked')) {
                                devices.push($(this).data('device'))
                            }
                        })

                        $('input[name ="devices"]').val(devices)

                        $.ajax({
                            type: "POST",
                            url: "{% url 'gift_agreement:save_gift_agreement_and_car' %}",
                            data: $(form).serialize(),
                            success: function (response) {
                                if (typeof response === 'object') {
                                    $('#next2').remove()
                                    $('#refresh_next2').css('display', 'block')
                                    $('#fieldset2').hide()
                                    if (is_legal === true) {
                                        $('#fieldset3-legal').show()
                                    } else {
                                        $('#fieldset3-person').show()
                                    }
                                    $('#payment').addClass('active')

                                    $('#car').attr('disabled', 'disabled')
                                    $('#engine_number').attr("disabled", "disabled")
                                    $('#body_number').attr("disabled", "disabled")
                                    $('#chassis_number').attr("disabled", "disabled")
                                    $('#body_type').attr("disabled", "disabled")
                                    $('#color').attr("disabled", "disabled")
                                    $('#made_year').attr("disabled", "disabled")
                                    $('.devices').attr("disabled", "disabled")
                                    $('#gift_agreement').attr("disabled", "disabled")
                                    $('#date_conclusion_contract').attr("disabled", "disabled")
                                    $('#lost_technical_passport').attr("disabled", "disabled")

                                     $('.copy_application').data('filename', response.fields.file_name)
                                }
                            },
                            error: function (response) {
                                console.log(response.status)
                            }
                        });
                        return false; // required to block normal submit since you used ajax
                    }
                });
            }

            $('.copy_application').on('click', function () {
                var filename = $(this).data('filename')
                var url = "{% url "application:create_application_doc" '123' %}";
                document.location.href = url.replace('123', filename);
            })

            $('#payment_render_pdf').on('click', function () {
                var pdf = new jsPDF('p', 'pt', 'letter');
                source = $('#render_div')[0];
                specialElementHandlers = {
                    '#bypassme': function (element, renderer) {
                        return true
                    }
                };
                margins = {
                    top: 80,
                    bottom: 60,
                    left: 40,
                    width: 1000
                };
                pdf.fromHTML(
                    source, // HTML string or DOM elem ref.
                    margins.left, // x coord
                    margins.top, { // y coord
                        'width': margins.width, // max width of content on PDF
                        'elementHandlers': specialElementHandlers
                    },
                    function (dispose) {
                        pdf.save("To'lov.pdf");
                    }, margins);
            })
        })
    </script>
{% endblock bottom %}