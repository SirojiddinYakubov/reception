{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block top %}
    <link rel="stylesheet" href="{% static "plugins/datatables-bs4/css/dataTables.bootstrap4.min.css" %}">
{% endblock top %}
{% block content %}
    <section class="py-3 mt-2 bg-info text-light">
        <div class="container">
            <div class="row text-center">
                <div class="col-12">
                    <h2>{% trans "Arizalar" %}</h2>
                </div>
            </div>
        </div>
    </section>
    <div class="container-fluid mt-3">
        <div class="row justify-content-center">

            <!-- left column -->
            <div class="col-xs-12 col-sm-8 col-md-9 col-lg-9 col-xl-10 mb-1">
                {% include '_parts/messages.html' %}
                {% if applications %}
                    <div class="table-responsive"
                         style="border: 1px solid #dbdada; border-radius: 3px; padding: 2% 2% 2% 2%;">

                        <table id="example1" class="table table-bordered table-responsive">
                            <thead class="thead-light">
                            <tr>
                                <th scope="col">Ariza raqami</th>
                                <th scope="col" style="width: 25%">Xizmat nomi</th>
                                <th scope="col">Avtomobil</th>
                                <th scope="col">Topshirdi</th>
                                <th scope="col">Yaratilgan vaqti</th>
                                <th scope="col">Ariza nusxasi</th>
                                <th scope="col">Holati</th>
                                <th scope="col">Tekshiruv paroli</th>
                                <th scope="col">O'chirish</th>
                            </tr>
                            </thead>
                            <tbody>

                            {% for application in applications %}
                                <tr>
                                    <th scope="row">{{ application.id }}</th>

                                    <td>
                                        <a href="{% url 'application:application_detail' application.id %}">{{ application.service.get_title_display }}</a>
                                    </td>
                                    <td class="text-center"><a
                                            href="{% url 'user:view_car_data' application.service.car.id %}">{{ application.service.car.model }}
                                        {% if application.service.car.old_number %}
                                            {{ application.service.car.old_number }}{% endif %}</a>
                                    </td>
                                    <td>{% if application.service.organization %}
                                        {{ application.service.organization }}{% else %}
                                        {{ application.created_user }}{% endif %}</td>

                                    <td>{{ application.created_date|date:'SHORT_DATETIME_FORMAT' }}</td>
                                    <td style="text-align: center;">
                                        <a class="btn btn-outline-primary"
                                           href="{% url 'application:create_application_doc' application.file_name %}"><i
                                                class="fas fa-download"></i></a>
                                    </td>
                                    {% if application.process == '1' %}
                                        <td style="color: #0f6674">Jarayonda</td>
                                    {% elif application.process == '2' %}
                                        <td style="color: #44ff00">Qabul qilindi</td>
                                    {% elif application.process == '3' %}
                                        <td style="color: #ff0318">Rad etildi</td>
                                    {% endif %}
                                    <td style="text-align: center; color: red">{{ application.password }}</td>
                                    <td style="text-align: center;">
                                        <button data-application="{{ application.id }}"
                                                class="btn btn-danger removeBtn"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
            <!--/.col (left) -->
            <div class="col-xs-12 col-sm-4 col-md-3 col-lg-3 col-xl-2">
                {% include 'application/right_filter_applications.html' %}
            </div>

        </div>
        <!-- /.row -->
    </div>
{% endblock content %}
{% block bottom %}
    <script src="{% static "plugins/datatables/jquery.dataTables.min.js" %}"></script>
    <script src="{% static "plugins/datatables-bs4/js/dataTables.bootstrap4.min.js" %}"></script>
    <script src="{% static "plugins/datatables-responsive/js/dataTables.responsive.min.js" %}"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>
        $(function () {
            $("#example1").DataTable({
                "responsive": true,
                "autoWidth": false,
            });
            $('#example2').DataTable({
                "paging": true,
                "lengthChange": false,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "responsive": true,
            });
        });

        $(document).ready(function () {
            var token = getCookie('token'),
                csrftoken = getCookie('csrftoken')

            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', csrftoken)
                    xhr.setRequestHeader('Authorization', `Token ${token}`)
                },
                error: function (response) {
                    if (response.status === 401) {
                        tokenInvalid()
                    }
                }
            })

            $('.removeBtn').on('click', function () {

                var applicationId = $(this).data('application')

                swal({
                    title: "Arizani o'chirmoqchimisiz ?",
                    text: applicationId + "-raqamli arizani o'chirmoqchimisiz ?",
                    icon: "warning",
                    closeOnClickOutside: false,
                    buttons: [
                        'Yoq, Bekor qilish!',
                        'Ha, Roziman!'
                    ],
                    dangerMode: true,
                }).then(function (isConfirm) {
                    if (isConfirm) {
                        $.ajax({
                            type: 'POST',
                            url: '{% url "application:remove_application" %}',
                            data: {
                                'application': applicationId
                            },
                            success: function (response) {
                                if (response === 'True') {
                                    swal({
                                        title: "Muvaffaqiyatli o'chirildi !",
                                        text: applicationId + "-raqamli ariza muvaffaqiyatli o'chirildi !",
                                        icon: 'success'
                                    }).then(function () {
                                        window.location.href = '{% url "application:applications_list" %}';
                                    });
                                } else if (response === 'disabled') {
                                    $.notifyDefaults({
                                        type: 'danger',
                                        allow_dismiss: false,
                                        animate: {
                                            enter: 'animated fadeInRight',
                                            exit: 'animated fadeOutRight'
                                        },
                                        z_index: '9999'
                                    })
                                    $.notify({
                                        icon: 'glyphicon glyphicon-star',
                                        message: `<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-patch-exclamation" fill="currentColor" xmlns="http://www.w3.org/2000/svg">\n' +
                                            '  <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>\n' +
                                            '  <path fill-rule="evenodd" d="M10.273 2.513l-.921-.944.715-.698.622.637.89-.011a2.89 2.89 0 0 1 2.924 2.924l-.01.89.636.622a2.89 2.89 0 0 1 0 4.134l-.637.622.011.89a2.89 2.89 0 0 1-2.924 2.924l-.89-.01-.622.636a2.89 2.89 0 0 1-4.134 0l-.622-.637-.89.011a2.89 2.89 0 0 1-2.924-2.924l.01-.89-.636-.622a2.89 2.89 0 0 1 0-4.134l.637-.622-.011-.89a2.89 2.89 0 0 1 2.924-2.924l.89.01.622-.636a2.89 2.89 0 0 1 4.134 0l-.715.698a1.89 1.89 0 0 0-2.704 0l-.92.944-1.32-.016a1.89 1.89 0 0 0-1.911 1.912l.016 1.318-.944.921a1.89 1.89 0 0 0 0 2.704l.944.92-.016 1.32a1.89 1.89 0 0 0 1.912 1.911l1.318-.016.921.944a1.89 1.89 0 0 0 2.704 0l.92-.944 1.32.016a1.89 1.89 0 0 0 1.911-1.912l-.016-1.318.944-.921a1.89 1.89 0 0 0 0-2.704l-.944-.92.016-1.32a1.89 1.89 0 0 0-1.912-1.911l-1.318.016z"/>\n' +
                                            '</svg> ${applicationId}-raqamli arizani o'chirishga ruxsat berilmaydi!`
                                    })
                                } else {
                                   errorFunction()
                                }

                            }
                        });


                    } else {
                        swal("Bekor qilindi", applicationId + "-raqamli ariza ro'yhatda turibti !", "error");
                    }
                });
            })
        })
    </script>
{% endblock bottom %}