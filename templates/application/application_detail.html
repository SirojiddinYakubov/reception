{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}
{% load applications_tags %}
{% block content %}

    <section class="py-3 mt-2 bg-info text-light">

        <div class="container">
            <div class="row text-center">
                <div class="col-12">
                    <h2>{% trans "Amallar xronologiyasi" %}</h2>
                </div>
            </div>
        </div>
    </section>
    {% if application.is_block %}
        <br>
        <div class="alert alert-danger">Ariza faollashtirilmagan! Arizani faollashtirish uchun to'lovni amalga
            oshiring!
            {#            <a class="close" href="#" data-dismiss="alert">Ã—</a>#}
        </div>
    {% endif %}
    {% include '_parts/messages.html' %}
    <div class="text-right mt-2 mb-2 mr-5">
        <button class="btn btn-default m-2 application_render_pdf" data-application="{{ application.id }}">
            Ariza haqida ma'lumot &nbsp&nbsp <i class="fas fa-download"></i>
        </button>
    </div>
    <div class="row">
        <div class="col-12" style="font-size: 0.9em">
            <div class="panel-group drop-accordion" id="accordion" role="tablist"
                 aria-multiselectable="true">
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingOne">
                        <h4 class="panel-title">
                            <a class="collapse-controle" data-toggle="collapse" data-parent="#accordion"
                               href="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                Ariza haqida ma'lumot
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>

                        </h4>
                    </div>

                    <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel"
                         aria-labelledby="headingOne" aria-expanded="false">
                        <div class="panel-body">
                           {% include 'application/inc/about_application_part.html' %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingTwo">
                        <h4 class="panel-title">
                            <a class="collapse-controle collapsed" data-toggle="collapse"
                               data-parent="#accordion" href="#collapseTwo" aria-expanded="false"
                               aria-controls="collapseTwo">
                                Ariza topshiruvchi
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingTwo" aria-expanded="false" style="height: 0px;">
                        <div class="panel-body">
                            {% include 'application/inc/application_submitting_part.html' %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingThree">
                        <h4 class="panel-title">
                            <a class="collapse-controle collapsed" data-toggle="collapse"
                               data-parent="#accordion" href="#collapseThree" aria-expanded="false"
                               aria-controls="collapseThree">
                                Avtomobil
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseThree" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingThree" aria-expanded="false" style="height: 0px;">
                        <div class="panel-body">
                   {% include 'application/inc/application_car_part.html' %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingFour">
                        <h4 class="panel-title">
                            <a class="collapsed collapse-controle" data-toggle="collapse"
                               data-parent="#accordion" href="#collapseFour" aria-expanded="false"
                               aria-controls="collapseFour">
                                Mavjud fayllar
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseFour" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingFour" aria-expanded="false">
                        <div class="panel-body">
                            {% include 'application/inc/application_files_part.html' %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingFifth">
                        <h4 class="panel-title">
                            <a class="collapsed collapse-controle" data-toggle="collapse"
                               data-parent="#accordion" href="#collapseFifth" aria-expanded="false"
                               aria-controls="collapseFifth">
                                To'lov
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseFifth" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingFifth" aria-expanded="false">
                        <div class="panel-body" id="render_div">
                            {% include 'application/inc/application_payments_part.html' %}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading tab-collapsed" role="tab" id="headingSix">
                        <h4 class="panel-title">
                            <a class="collapsed collapse-controle" data-toggle="collapse"
                               data-parent="#accordion" href="#collapseSix" aria-expanded="false"
                               aria-controls="collapseSix">
                                Ariza holati
                                <span class="expand-icon-wrap"><i style="padding: 0.5em"
                                                                  class="fas fa-angle-double-down"></i></span>
                            </a>
                        </h4>
                    </div>
                    <div id="collapseSix" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="headingSix" aria-expanded="false">
                        <div class="panel-body">
                            {% include 'application/inc/application_status_part.html' %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- /#accordion -->
        </div>
    </div>

{% endblock content %}
{% block bottom %}
    <script type="text/javascript">


        $('#collapseOne').collapse('show');

        $('.application_render_pdf').on('click', function () {
            var applicationId = $(this).data('application')
            window.location.href = "{% url 'application:application_pdf' id=12345 %}".replace(/12345/, applicationId.toString());
        })

        $('#payment_render_pdf').on('click', function () {
            var element = document.getElementById('render_div'),
                filename = `To'lov`

            html_to_pdf(element, filename)
        })
        calc_total()

        function calc_total() {
            if (!String.prototype.trim) {
                String.prototype.trim = function () {
                    return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
                };
            }

            var sum = 0;
            $(".state_payment").each(function () {
                sum += parseFloat($(this).text().replace(/\s+/g, ''));
            });
            $('#total_state_payments').text(sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " "))
        }

        var token = getCookie('token'),
            csrftoken = getCookie('csrftoken')

        $.ajaxSetup({
            beforeSend: function (xhr) {
                xhr.setRequestHeader('X-CSRFToken', csrftoken)
                xhr.setRequestHeader('Authorization', `Token ${token}`)
            },
            error: function (response) {
                if (response.status === 401) {
                    tokenInvalid()
                }
            }
        })

        $('.payment_checkbox').on('change', function () {
            let modify
            if ($(this).prop('checked')) {
                modify = true
            } else {
                modify = false
            }

            $.ajax({
                type: 'POST',
                url: '{% url "application:modify_payment_checkbox" %}',
                data: {
                    'modify': modify,
                    'payment': $(this).data('payment'),
                },
                success: function (res) {
                    if (res === 'True') {
                        edit_toast()
                    } else {
                        errorFunction()
                    }
                },
                error: function (err) {
                    errorFunction()
                }
            })
        })

    </script>
{% endblock bottom %}
