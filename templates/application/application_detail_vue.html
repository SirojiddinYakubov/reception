{% extends 'base_vertical.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}
{% load applications_tags %}
{% block css %}
    <style>
        .table-striped > tbody > tr:nth-of-type(odd) {
            --bs-table-accent-bg: #e9eef1;
            color: var(--bs-table-striped-color);
        }

        .accordion-button {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem 1.25rem;
            font-size: .875rem;
            color: #6c757d;
            text-align: left;
            background-color: #dfe2e4;
            border: 0;
            border-radius: 0;
            overflow-anchor: none;
            transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out, border-radius .15s ease;
            border: 1px dashed darkblue;
        }

    </style>

    <!-- Sweet Alert-->
    <link href="{% static 'assets/libs/sweetalert2/sweetalert2.min.css' %}" rel="stylesheet" type="text/css"/>


{% endblock css %}

{% block page_title %}
    {% trans 'Amalllar xronologiyasi' %}
{% endblock page_title %}

{% block content %}
    <div class="row" id="app">
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="about"
                           ref="about"
                           v-if="application"
                           v-model="isOpenAboutAccordion"
                           :application="application"
                           @open-payment="() => {isOpenPaymentAccordion = true; isOpenAboutAccordion = false}"
                ></component>
            </div>
        </div>
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="payment"
                           v-if="application"
                           v-model="isOpenPaymentAccordion"
                           :application="application"
                ></component>
            </div>
        </div>
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="applicant"
                           v-if="application"
                           v-model="isOpenApplicantAccordion"
                           :application="application"
                ></component>
            </div>
        </div>
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="car"
                           v-if="application"
                           v-model="isOpenCarAccordion"
                           :application="application"
                ></component>
            </div>
        </div>
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="document"
                           v-if="application"
                           v-model="isOpenDocumentAccordion"
                           :application="application"
                ></component>
            </div>
        </div>
        <div class="col-12 info_area">
            <div class="accordion">
                <component is="status"
                           v-if="application"
                           v-model="isOpenStatusAccordion"
                           :application="application"
                ></component>
            </div>
        </div>
    </div>
{% endblock content %}
{% block js %}
    <script src="{% static 'assets/libs/html2pdf/html2pdf.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'assets/libs/sweetalert2/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'assets/libs/bootstrap-notify/bootstrap-notify.min.js' %}"></script>
    <script src="{% static 'assets/libs/axios/axios.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'assets/libs/moment/moment.js' %}"></script>
    <script src="{% static 'assets/libs/moment/locale/ru.js' %}"></script>
    <script src="https://unpkg.com/http-vue-loader"></script>
    <script src="{% static 'assets/libs/cryptoJS/cryptoJS.js' %}"></script>
    <!-- development version -->
    {#    <script src="{% static 'vue/vue.dev.js' %}"></script>#}
    <!-- production version -->
    <script src="{% static 'vue/vue.prod.js' %}"></script>

    <script type="text/javascript">
        setAxiosHeader()
        const vm = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: () => ({
                application: null,

                isOpenAboutAccordion: true,
                isOpenPaymentAccordion: false,
                isOpenApplicantAccordion: false,
                isOpenCarAccordion: false,
                isOpenDocumentAccordion: false,
                isOpenStatusAccordion: false
            }),
            components: {
                'About': httpVueLoader('/static/vue/components/application/AboutApplicationAccordion.vue'),
                'Payment': httpVueLoader('/static/vue/components/application/PaymentApplicationAccordion.vue'),
                'Applicant': httpVueLoader('/static/vue/components/application/ApplicantApplicationAccordion.vue'),
                'Car': httpVueLoader('/static/vue/components/application/CarApplicationAccordion.vue'),
                'Document': httpVueLoader('/static/vue/components/application/DocumentApplicationAccordion.vue'),
                'Status': httpVueLoader('/static/vue/components/application/StatusApplicationAccordion.vue'),
            },
            created() {
                let url = document.URL

                var applicationId = url.match(/application-detail\/(\d+)/)[1]

                if (applicationId) {
                    this.getApplicationDetail(applicationId)
                }
                this.getCurrentUser()
            },
            methods: {
                async getCurrentUser() {
                    this.userId = await axios.get('/api/v1/user/auth/users/me/')
                        .then(res => res.data.id)
                    this.getUserDetail()
                },
                async getUserDetail() {
                    this.user = await axios.get(`/api/v1/user/detail/${this.userId}/`).then(res => res.data)
                },
                async getApplicationDetail(id) {
                    this.application = await axios.get(`/api/v1/application/detail/${id}/`).then((response) => response.data)
                    this.check_errors()
                },
                async check_errors() {
                    await this.application
                    await this.user
                    if (this.application && this.user) {
                        if (this.user.id === this.application.applicant.id) {

                            console.log(this.application.process)
                            console.log(this.application.is_block)

                            if (this.application.process === 7 && this.application.is_block) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    showCloseButton: true,
                                    showCancelButton: false,
                                    showConfirmButton: true,
                                    showLoaderOnConfirm: true,
                                    confirmButtonText: "To'lov qilish",
                                    {#cancelButtonText: 'Bekor qilish',#}
                                    icon: 'error',
                                    title: 'Ariza aktivlashtirilmagan!',
                                    text: `Arizani aktivlashitirish uchun ariza jo'natiladigan YHXB RIB bo'limini va ${this.application.activation_pay} so'm to'lovni amalga oshirishingiz talab etiladi!`,
                                    {#footer: '<a href="">To\'lovni keyinroq amalga oshiraman</a>'#}
                                }).then((confirm) => {
                                    if (confirm.isConfirmed) {
                                        this.select_payment()
                                        {#window.location.href = '{% url 'paycom:create_paycom_url_via_order' %}' + `?amount=${activation_pay}&application=${applicationId}`#}
                                    }
                                })
                            } else if (this.application.process === 7) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    showCloseButton: true,
                                    showCancelButton: false,
                                    showConfirmButton: true,
                                    showLoaderOnConfirm: true,
                                    confirmButtonText: "Kiritish",
                                    {#cancelButtonText: 'Bekor qilish',#}
                                    icon: 'error',
                                    title: 'Ariza to\'liq to\'ldirilmagan!',
                                    text: `Arizani to'liq to'ldirish uchun ariza jo'natiladigan YHXB RIB bo'limini kiriting!`,
                                    {#footer: '<a href="">To\'lovni keyinroq amalga oshiraman</a>'#}
                                }).then((confirm) => {
                                    if (confirm.isConfirmed) {
                                        this.selectSection()
                                    }

                                })
                            } else if (this.application.is_block) {
                                Swal.fire({
                                    allowOutsideClick: false,
                                    showCloseButton: true,
                                    showCancelButton: false,
                                    showConfirmButton: true,
                                    showLoaderOnConfirm: true,
                                    confirmButtonText: "To'lov qilish",
                                    {#cancelButtonText: 'Bekor qilish',#}
                                    icon: 'error',
                                    title: 'Ariza aktivlashtirilmagan!',
                                    text: `Arizani aktivlashitirish uchun ${this.application.activation_pay} so'm to'lovni amalga oshirishingiz talab etiladi!`,
                                    {#footer: '<a href="">To\'lovni keyinroq amalga oshiraman</a>'#}
                                }).then((confirm) => {
                                    if (confirm.isConfirmed) {
                                        this.select_payment()
                                    }
                                })
                            } else if (!this.application.is_block && this.application.process === 0) {
                                Swal.fire({
                                    allowOutsideClick: true,
                                    showCloseButton: true,
                                    showCancelButton: false,
                                    showConfirmButton: true,
                                    showLoaderOnConfirm: true,
                                    confirmButtonText: "Jo'natish",
                                    {#cancelButtonText: 'Bekor qilish',#}
                                    icon: 'error',
                                    title: `Ariza ${this.application.section.title}ga jo'natilmagan!`,
                                    text: `Ariza to'liq to'ldirilgan lekin ${this.application.section.title}ga jo'natilmagan!`,
                                    {#footer: '<a href="">To\'lovni keyinroq amalga oshiraman</a>'#}
                                }).then((confirm) => {
                                    if (confirm.isConfirmed) {
                                        this.draftToShipped()
                                    }

                                })
                            }
                        }
                    }
                },
                select_payment() {
                    Swal.fire({
                        allowOutsideClick: false,
                        showCloseButton: true,
                        showCancelButton: false,
                        showConfirmButton: false,
                        showLoaderOnConfirm: true,
                        title: 'To\'lov turini tanlang!',
                        html: "<div class='row'>" +
                            "<div style='border: 1px solid #fff' class='col-6'><a href='#' id='click'><img width='90%' src=\'{% static 'online/clickuz.png' %}\' alt='clickuz'></a></div>" +
                            "<div class='col-6'><a href='#' id='payme'><img width='90%' src=\'{% static 'online/payme.png' %}\' alt='payme'></a></div>" +
                            "</div>",
                    })
                },
                draftToShipped() {
                    Swal.fire({
                        text: `Jo'natiladigan YHXB RIB bo'limi: ` + this.application.section.title,
                        title: "Arizadagi ma'lumotlar to'g'ri ekanligiga ishonchingiz komilmi?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Ha, albatta',
                        cancelButtonText: 'Bilmadim',
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            this.requiredDocuments = await axios.post(`/api/v1/application/send-application-to-section/${this.application.id}/`)
                                .then((response) => {
                                    return response.data
                                }).catch((error) => {
                                    if (error.response) {
                                        Swal.fire(
                                            'Xatolik!',
                                            `${error.response.data}`,
                                            'error',
                                        ).then(function () {
                                            location.reload()
                                        })
                                    } else {
                                        console.log(error)
                                    }
                                })

                        }
                    })
                },
                selectSection() {
                    Swal.fire({
                        title: "YXHB bo'limi joylashgan viloyatni tanlang",
                        confirmButtonText: 'Tanlash',
                        input: 'select',
                        inputOptions: this.getRegions(),

                    }).then((confirm) => {

                        if (confirm.isConfirmed) {
                            Swal.fire({
                                title: "Ariza jo'natiladigan YHXB bo'limini tanlang",
                                confirmButtonText: "Jo'natish",
                                input: 'select',
                                inputOptions: this.getSections(confirm.value),
                            }).then((confirm) => {
                                if (confirm.isConfirmed) {

                                    const formData = new FormData()
                                    formData.append('section', confirm.value)
                                    formData.append('process', 1)
                                    axios.patch(`/api/v1/application/save/application/section/${this.application.id}/`, formData)
                                        .then((response) => {
                                            location.reload()
                                        })
                                        .catch((error) => {
                                            if (error.response) {
                                                swal_error(error.response.data)
                                            }
                                        })
                                }

                            })
                        }
                    })
                },
                getRegions() {
                    return new Promise((resolve, reject) => {
                        axios.get('/api/v1/user/section/exists/regions/list/').then((response) => {
                            const regions = {}
                            for (const x of response.data) {
                                regions[x.id] = x.title
                            }
                            resolve(regions)
                        }).catch((error) => {
                            reject(error)
                        })
                    })
                },
                getSections(id) {
                    return new Promise((resolve, reject) => {
                        axios.get(`/api/v1/user/region/${id}/sections/list/`).then((response) => {
                            const sections = {}
                            for (const x of response.data) {
                                sections[x.id] = x.title
                            }
                            resolve(sections)
                        }).catch((error) => {
                            reject(error)
                        })
                    })
                },
            }
        })
        $('body').on('click', '#click, #payme', function (e) {
            if ($(e.currentTarget).attr('id') === 'click') {
                $('#load').show()
                {#alert('Click integratsiya jarayonida, Paymedan foydalanishingiz mumkin!')#}
                window.location.href = '{% url 'click:create_click_order' %}' + `?amount=${vm._data.application.activation_pay}&application=${vm._data.application.id}`
            } else if ($(e.currentTarget).attr('id') === 'payme') {
                $('#load').show()
                window.location.href = '{% url 'paycom:create_payme_order' %}' + `?amount=${vm._data.application.activation_pay}&application=${vm._data.application.id}`
            }
        })

    </script>
{% endblock js %}
